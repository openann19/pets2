ceeec96eaa71f90686de749f6e3ed9ac
"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");
Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.useChatData = useChatData;
var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));
var _asyncToGenerator2 = _interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));
var _toConsumableArray2 = _interopRequireDefault(require("@babel/runtime/helpers/toConsumableArray"));
var _slicedToArray2 = _interopRequireDefault(require("@babel/runtime/helpers/slicedToArray"));
var _react = require("react");
var _reactNative = require("react-native");
var _core = require("@pawfectmatch/core");
var _logger = require("../services/logger");
var _api = require("../services/api");
var _useSocket = require("./useSocket");
function ownKeys(e, r) { var t = Object.keys(e); if (Object.getOwnPropertySymbols) { var o = Object.getOwnPropertySymbols(e); r && (o = o.filter(function (r) { return Object.getOwnPropertyDescriptor(e, r).enumerable; })), t.push.apply(t, o); } return t; }
function _objectSpread(e) { for (var r = 1; r < arguments.length; r++) { var t = null != arguments[r] ? arguments[r] : {}; r % 2 ? ownKeys(Object(t), !0).forEach(function (r) { (0, _defineProperty2.default)(e, r, t[r]); }) : Object.getOwnPropertyDescriptors ? Object.defineProperties(e, Object.getOwnPropertyDescriptors(t)) : ownKeys(Object(t)).forEach(function (r) { Object.defineProperty(e, r, Object.getOwnPropertyDescriptor(t, r)); }); } return e; }
var MAX_MESSAGE_LENGTH = 500;
var TYPING_TIMEOUT = 2000;
var MESSAGE_BATCH_SIZE = 20;
function useChatData(matchId) {
  var _useAuthStore = (0, _core.useAuthStore)(),
    user = _useAuthStore.user;
  var _useState = (0, _react.useState)([]),
    _useState2 = (0, _slicedToArray2.default)(_useState, 2),
    messages = _useState2[0],
    setMessages = _useState2[1];
  var _useState3 = (0, _react.useState)(true),
    _useState4 = (0, _slicedToArray2.default)(_useState3, 2),
    isLoading = _useState4[0],
    setIsLoading = _useState4[1];
  var _useState5 = (0, _react.useState)(false),
    _useState6 = (0, _slicedToArray2.default)(_useState5, 2),
    isSending = _useState6[0],
    setIsSending = _useState6[1];
  var _useState7 = (0, _react.useState)(true),
    _useState8 = (0, _slicedToArray2.default)(_useState7, 2),
    isOnline = _useState8[0],
    setIsOnline = _useState8[1];
  var _useState9 = (0, _react.useState)(false),
    _useState0 = (0, _slicedToArray2.default)(_useState9, 2),
    otherUserTyping = _useState0[0],
    setOtherUserTyping = _useState0[1];
  var _useState1 = (0, _react.useState)([]),
    _useState10 = (0, _slicedToArray2.default)(_useState1, 2),
    typingUsers = _useState10[0],
    setTypingUsers = _useState10[1];
  var _useState11 = (0, _react.useState)(null),
    _useState12 = (0, _slicedToArray2.default)(_useState11, 2),
    error = _useState12[0],
    setError = _useState12[1];
  var typingTimeoutRef = (0, _react.useRef)(null);
  var socket = (0, _useSocket.useSocket)();
  (0, _react.useEffect)(function () {
    if (!socket) {
      _logger.logger.debug("Socket not available yet", {
        matchId: matchId
      });
      return;
    }
    _logger.logger.info("Socket connected for chat", {
      matchId: matchId,
      socketId: socket.id
    });
    var handleNewMessage = function handleNewMessage(message) {
      _logger.logger.debug("New message received via socket", {
        message: message
      });
      setMessages(function (prev) {
        return [].concat((0, _toConsumableArray2.default)(prev), [message]);
      });
    };
    var handleUserTyping = function handleUserTyping(data) {
      if (data.matchId === matchId) {
        setOtherUserTyping(data.isTyping);
        if (data.isTyping) {
          setTypingUsers(function (prev) {
            return (0, _toConsumableArray2.default)(new Set([].concat((0, _toConsumableArray2.default)(prev), [data.userId])));
          });
        } else {
          setTypingUsers(function (prev) {
            return prev.filter(function (id) {
              return id !== data.userId;
            });
          });
        }
      }
    };
    var handleUserOnline = function handleUserOnline(data) {
      setIsOnline(true);
      _logger.logger.debug("User came online", {
        data: data
      });
    };
    var handleUserOffline = function handleUserOffline(data) {
      setIsOnline(false);
      _logger.logger.debug("User went offline", {
        data: data
      });
    };
    socket.on("new_message", handleNewMessage);
    socket.on("typing", handleUserTyping);
    socket.on("user_online", handleUserOnline);
    socket.on("user_offline", handleUserOffline);
    socket.emit("join_match", {
      matchId: matchId
    });
    return function () {
      _logger.logger.debug("Cleaning up socket listeners", {
        matchId: matchId
      });
      socket.off("new_message", handleNewMessage);
      socket.off("typing", handleUserTyping);
      socket.off("user_online", handleUserOnline);
      socket.off("user_offline", handleUserOffline);
      socket.emit("leave_match", {
        matchId: matchId
      });
    };
  }, [socket, matchId]);
  var convertMessage = (0, _react.useCallback)(function (coreMsg) {
    var senderId = typeof coreMsg.sender === 'string' ? coreMsg.sender : coreMsg.sender._id;
    return {
      _id: coreMsg._id,
      content: coreMsg.content,
      senderId: senderId,
      timestamp: coreMsg.sentAt,
      read: coreMsg.readBy.length > 0,
      type: coreMsg.messageType === 'text' ? 'text' : coreMsg.messageType === 'image' ? 'image' : coreMsg.messageType === 'voice' ? 'voice' : 'text',
      replyTo: coreMsg.replyTo,
      error: false
    };
  }, []);
  var loadMessages = (0, _react.useCallback)((0, _asyncToGenerator2.default)(function* () {
    try {
      setIsLoading(true);
      setError(null);
      var coreMessages = yield _api.matchesAPI.getMessages(matchId);
      if (coreMessages.length > 0) {
        var convertedMessages = coreMessages.map(convertMessage);
        setMessages(convertedMessages);
        yield markAsRead();
      } else {
        setMessages([]);
      }
    } catch (err) {
      var errorMessage = "Failed to load messages. Please check your connection and try again.";
      _logger.logger.error("Failed to load messages", {
        error: err instanceof Error ? err : new Error(String(err)),
        matchId: matchId
      });
      setError(errorMessage);
      _reactNative.Alert.alert("Connection Error", errorMessage);
    } finally {
      setIsLoading(false);
    }
  }), [matchId, convertMessage]);
  var sendMessage = (0, _react.useCallback)(function () {
    var _ref2 = (0, _asyncToGenerator2.default)(function* (content, replyTo) {
      var _user$_id;
      if (!content.trim() || isSending) return;
      var messageContent = content.trim();
      var tempId = `temp_${Date.now()}`;
      var optimisticMessage = {
        _id: tempId,
        content: messageContent,
        senderId: (_user$_id = user == null ? void 0 : user._id) != null ? _user$_id : "me",
        timestamp: new Date().toISOString(),
        read: false,
        type: "text",
        status: "sending",
        replyTo: replyTo ? {
          _id: replyTo._id,
          author: replyTo.author,
          text: replyTo.text
        } : undefined
      };
      setIsSending(true);
      setMessages(function (prev) {
        return [].concat((0, _toConsumableArray2.default)(prev), [optimisticMessage]);
      });
      try {
        var sentMessage = yield _api.matchesAPI.sendMessage(matchId, messageContent, replyTo);
        var convertedSentMessage = convertMessage(sentMessage);
        setMessages(function (prev) {
          return prev.map(function (msg) {
            return msg._id === tempId ? _objectSpread(_objectSpread({}, convertedSentMessage), {}, {
              status: "sent"
            }) : msg;
          });
        });
        if (socket && socket.connected) {
          socket.emit("send_message", sentMessage);
          socket.emit("typing", {
            matchId: matchId,
            userId: user == null ? void 0 : user._id,
            isTyping: false
          });
        }
        setTimeout(function () {
          setOtherUserTyping(true);
          setTimeout(function () {
            setOtherUserTyping(false);
            var response = {
              _id: `response_${Date.now()}`,
              content: getIntelligentResponse(messageContent),
              senderId: "other",
              timestamp: new Date().toISOString(),
              read: false,
              type: "text"
            };
            setMessages(function (prev) {
              return [].concat((0, _toConsumableArray2.default)(prev), [response]);
            });
          }, 1500 + Math.random() * 1000);
        }, 800);
      } catch (err) {
        _logger.logger.error("Failed to send message", {
          error: err instanceof Error ? err : new Error(String(err)),
          matchId: matchId,
          content: content
        });
        setMessages(function (prev) {
          return prev.map(function (msg) {
            return msg._id === tempId ? _objectSpread(_objectSpread({}, msg), {}, {
              status: "failed",
              error: true
            }) : msg;
          });
        });
        setError("Failed to send message. Please try again.");
      } finally {
        setIsSending(false);
      }
    });
    return function (_x, _x2) {
      return _ref2.apply(this, arguments);
    };
  }(), [isSending, user == null ? void 0 : user._id, matchId]);
  var retryMessage = (0, _react.useCallback)(function () {
    var _ref3 = (0, _asyncToGenerator2.default)(function* (messageId) {
      var message = messages.find(function (msg) {
        return msg._id === messageId;
      });
      if (!message) return;
      var retryMessage = _objectSpread(_objectSpread({}, message), {}, {
        _id: `retry_${Date.now()}`,
        status: "sending",
        error: false
      });
      setMessages(function (prev) {
        return prev.map(function (msg) {
          return msg._id === messageId ? retryMessage : msg;
        });
      });
      try {
        yield _api.matchesAPI.sendMessage(matchId, message.content);
        setMessages(function (prev) {
          return prev.map(function (msg) {
            return msg._id === retryMessage._id ? _objectSpread(_objectSpread({}, msg), {}, {
              status: "sent",
              error: false
            }) : msg;
          });
        });
      } catch (err) {
        _logger.logger.error("Failed to retry message", {
          error: err instanceof Error ? err : new Error(String(err)),
          messageId: messageId
        });
        setMessages(function (prev) {
          return prev.map(function (msg) {
            return msg._id === retryMessage._id ? _objectSpread(_objectSpread({}, msg), {}, {
              status: "failed",
              error: true
            }) : msg;
          });
        });
      }
    });
    return function (_x3) {
      return _ref3.apply(this, arguments);
    };
  }(), [messages, matchId]);
  var markAsRead = (0, _react.useCallback)((0, _asyncToGenerator2.default)(function* () {
    try {
      _logger.logger.debug("Messages marked as read", {
        matchId: matchId
      });
      setMessages(function (prev) {
        return prev.map(function (msg) {
          return _objectSpread(_objectSpread({}, msg), {}, {
            read: true
          });
        });
      });
    } catch (err) {
      _logger.logger.error("Failed to mark messages as read", {
        error: err instanceof Error ? err : new Error(String(err)),
        matchId: matchId
      });
    }
  }), [matchId]);
  var clearError = (0, _react.useCallback)(function () {
    setError(null);
  }, []);
  (0, _react.useEffect)(function () {
    loadMessages();
  }, [loadMessages]);
  (0, _react.useEffect)(function () {
    return function () {
      if (typingTimeoutRef.current) {
        clearTimeout(typingTimeoutRef.current);
      }
    };
  }, []);
  return {
    data: {
      messages: messages,
      isLoading: isLoading,
      isSending: isSending,
      isOnline: isOnline,
      otherUserTyping: otherUserTyping,
      typingUsers: typingUsers,
      error: error
    },
    actions: {
      sendMessage: sendMessage,
      loadMessages: loadMessages,
      retryMessage: retryMessage,
      markAsRead: markAsRead,
      clearError: clearError
    }
  };
}
function getIntelligentResponse(messageContent) {
  var _responses$randomInde;
  var content = messageContent.toLowerCase();
  if (content.includes("weekend") || content.includes("saturday") || content.includes("sunday")) {
    return "Weekends work perfectly for me! My schedule is pretty flexible then 📅";
  }
  if (content.includes("park") || content.includes("dog park")) {
    return "The dog park sounds amazing! My pup absolutely loves meeting new friends there 🌳🐕";
  }
  if (content.includes("time") || content.includes("when")) {
    return "I'm pretty flexible with timing! What works best for your schedule? ⏰";
  }
  if (content.includes("weather") || content.includes("sunny") || content.includes("perfect")) {
    return "Yes! I checked the forecast too - it's going to be beautiful! Perfect day for our pets to play ☀️";
  }
  if (content.includes("excited") || content.includes("can't wait") || content.includes("looking forward")) {
    return "Me too! This is going to be so much fun. I think our pets are going to be best friends! 🐾💕";
  }
  if (content.includes("photo") || content.includes("picture") || content.includes("pic")) {
    return "I'd love to see more photos! Your pet is absolutely adorable 📸✨";
  }
  var responses = ["That sounds absolutely perfect! I'm really looking forward to it 🎾", "Amazing! My pet is going to be so excited to meet yours 🐕💕", "Perfect! I think this is going to be the start of a beautiful friendship 😊", "Wonderful! I can already tell our pets are going to get along great 🌟", "Fantastic! This is exactly what I was hoping for 🎉", "Love it! I have a really good feeling about this playdate ✨"];
  var randomIndex = Math.floor(Math.random() * responses.length);
  return (_responses$randomInde = responses[randomIndex]) != null ? _responses$randomInde : "Sounds great!";
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJfcmVhY3QiLCJyZXF1aXJlIiwiX3JlYWN0TmF0aXZlIiwiX2NvcmUiLCJfbG9nZ2VyIiwiX2FwaSIsIl91c2VTb2NrZXQiLCJvd25LZXlzIiwiZSIsInIiLCJ0IiwiT2JqZWN0Iiwia2V5cyIsImdldE93blByb3BlcnR5U3ltYm9scyIsIm8iLCJmaWx0ZXIiLCJnZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IiLCJlbnVtZXJhYmxlIiwicHVzaCIsImFwcGx5IiwiX29iamVjdFNwcmVhZCIsImFyZ3VtZW50cyIsImxlbmd0aCIsImZvckVhY2giLCJfZGVmaW5lUHJvcGVydHkyIiwiZGVmYXVsdCIsImdldE93blByb3BlcnR5RGVzY3JpcHRvcnMiLCJkZWZpbmVQcm9wZXJ0aWVzIiwiZGVmaW5lUHJvcGVydHkiLCJNQVhfTUVTU0FHRV9MRU5HVEgiLCJUWVBJTkdfVElNRU9VVCIsIk1FU1NBR0VfQkFUQ0hfU0laRSIsInVzZUNoYXREYXRhIiwibWF0Y2hJZCIsIl91c2VBdXRoU3RvcmUiLCJ1c2VBdXRoU3RvcmUiLCJ1c2VyIiwiX3VzZVN0YXRlIiwidXNlU3RhdGUiLCJfdXNlU3RhdGUyIiwiX3NsaWNlZFRvQXJyYXkyIiwibWVzc2FnZXMiLCJzZXRNZXNzYWdlcyIsIl91c2VTdGF0ZTMiLCJfdXNlU3RhdGU0IiwiaXNMb2FkaW5nIiwic2V0SXNMb2FkaW5nIiwiX3VzZVN0YXRlNSIsIl91c2VTdGF0ZTYiLCJpc1NlbmRpbmciLCJzZXRJc1NlbmRpbmciLCJfdXNlU3RhdGU3IiwiX3VzZVN0YXRlOCIsImlzT25saW5lIiwic2V0SXNPbmxpbmUiLCJfdXNlU3RhdGU5IiwiX3VzZVN0YXRlMCIsIm90aGVyVXNlclR5cGluZyIsInNldE90aGVyVXNlclR5cGluZyIsIl91c2VTdGF0ZTEiLCJfdXNlU3RhdGUxMCIsInR5cGluZ1VzZXJzIiwic2V0VHlwaW5nVXNlcnMiLCJfdXNlU3RhdGUxMSIsIl91c2VTdGF0ZTEyIiwiZXJyb3IiLCJzZXRFcnJvciIsInR5cGluZ1RpbWVvdXRSZWYiLCJ1c2VSZWYiLCJzb2NrZXQiLCJ1c2VTb2NrZXQiLCJ1c2VFZmZlY3QiLCJsb2dnZXIiLCJkZWJ1ZyIsImluZm8iLCJzb2NrZXRJZCIsImlkIiwiaGFuZGxlTmV3TWVzc2FnZSIsIm1lc3NhZ2UiLCJwcmV2IiwiY29uY2F0IiwiX3RvQ29uc3VtYWJsZUFycmF5MiIsImhhbmRsZVVzZXJUeXBpbmciLCJkYXRhIiwiaXNUeXBpbmciLCJTZXQiLCJ1c2VySWQiLCJoYW5kbGVVc2VyT25saW5lIiwiaGFuZGxlVXNlck9mZmxpbmUiLCJvbiIsImVtaXQiLCJvZmYiLCJjb252ZXJ0TWVzc2FnZSIsInVzZUNhbGxiYWNrIiwiY29yZU1zZyIsInNlbmRlcklkIiwic2VuZGVyIiwiX2lkIiwiY29udGVudCIsInRpbWVzdGFtcCIsInNlbnRBdCIsInJlYWQiLCJyZWFkQnkiLCJ0eXBlIiwibWVzc2FnZVR5cGUiLCJyZXBseVRvIiwibG9hZE1lc3NhZ2VzIiwiX2FzeW5jVG9HZW5lcmF0b3IyIiwiY29yZU1lc3NhZ2VzIiwibWF0Y2hlc0FQSSIsImdldE1lc3NhZ2VzIiwiY29udmVydGVkTWVzc2FnZXMiLCJtYXAiLCJtYXJrQXNSZWFkIiwiZXJyIiwiZXJyb3JNZXNzYWdlIiwiRXJyb3IiLCJTdHJpbmciLCJBbGVydCIsImFsZXJ0Iiwic2VuZE1lc3NhZ2UiLCJfcmVmMiIsIl91c2VyJF9pZCIsInRyaW0iLCJtZXNzYWdlQ29udGVudCIsInRlbXBJZCIsIkRhdGUiLCJub3ciLCJvcHRpbWlzdGljTWVzc2FnZSIsInRvSVNPU3RyaW5nIiwic3RhdHVzIiwiYXV0aG9yIiwidGV4dCIsInVuZGVmaW5lZCIsInNlbnRNZXNzYWdlIiwiY29udmVydGVkU2VudE1lc3NhZ2UiLCJtc2ciLCJjb25uZWN0ZWQiLCJzZXRUaW1lb3V0IiwicmVzcG9uc2UiLCJnZXRJbnRlbGxpZ2VudFJlc3BvbnNlIiwiTWF0aCIsInJhbmRvbSIsIl94IiwiX3gyIiwicmV0cnlNZXNzYWdlIiwiX3JlZjMiLCJtZXNzYWdlSWQiLCJmaW5kIiwiX3gzIiwiY2xlYXJFcnJvciIsImN1cnJlbnQiLCJjbGVhclRpbWVvdXQiLCJhY3Rpb25zIiwiX3Jlc3BvbnNlcyRyYW5kb21JbmRlIiwidG9Mb3dlckNhc2UiLCJpbmNsdWRlcyIsInJlc3BvbnNlcyIsInJhbmRvbUluZGV4IiwiZmxvb3IiXSwic291cmNlcyI6WyJ1c2VDaGF0RGF0YS50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyB1c2VDYWxsYmFjaywgdXNlRWZmZWN0LCB1c2VSZWYsIHVzZVN0YXRlIH0gZnJvbSBcInJlYWN0XCI7XG5pbXBvcnQgQXN5bmNTdG9yYWdlIGZyb20gXCJAcmVhY3QtbmF0aXZlLWFzeW5jLXN0b3JhZ2UvYXN5bmMtc3RvcmFnZVwiO1xuaW1wb3J0IHsgQWxlcnQgfSBmcm9tIFwicmVhY3QtbmF0aXZlXCI7XG5pbXBvcnQgeyB1c2VBdXRoU3RvcmUgfSBmcm9tIFwiQHBhd2ZlY3RtYXRjaC9jb3JlXCI7XG5pbXBvcnQgdHlwZSB7IE1lc3NhZ2UgYXMgQ29yZU1lc3NhZ2UgfSBmcm9tIFwiQHBhd2ZlY3RtYXRjaC9jb3JlXCI7XG5pbXBvcnQgeyBsb2dnZXIgfSBmcm9tIFwiLi4vc2VydmljZXMvbG9nZ2VyXCI7XG5pbXBvcnQgeyBtYXRjaGVzQVBJIH0gZnJvbSBcIi4uL3NlcnZpY2VzL2FwaVwiO1xuaW1wb3J0IHsgdXNlU29ja2V0IH0gZnJvbSBcIi4vdXNlU29ja2V0XCI7XG5cbmV4cG9ydCBpbnRlcmZhY2UgTWVzc2FnZSB7XG4gIF9pZDogc3RyaW5nO1xuICBtYXRjaElkPzogc3RyaW5nO1xuICBjb250ZW50OiBzdHJpbmc7XG4gIHNlbmRlcklkOiBzdHJpbmc7XG4gIHRpbWVzdGFtcDogc3RyaW5nO1xuICByZWFkOiBib29sZWFuO1xuICB0eXBlOiBcInRleHRcIiB8IFwiaW1hZ2VcIiB8IFwiZW1vamlcIiB8IFwidm9pY2VcIjtcbiAgc3RhdHVzPzogXCJzZW5kaW5nXCIgfCBcInNlbnRcIiB8IFwiZmFpbGVkXCI7XG4gIGVycm9yPzogYm9vbGVhbjtcbiAgYXVkaW9Vcmw/OiBzdHJpbmc7XG4gIGR1cmF0aW9uPzogbnVtYmVyO1xuICByZXBseVRvPzogeyBfaWQ6IHN0cmluZzsgYXV0aG9yPzogc3RyaW5nOyB0ZXh0Pzogc3RyaW5nIH07XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgQ2hhdERhdGEge1xuICBtZXNzYWdlczogTWVzc2FnZVtdO1xuICBpc0xvYWRpbmc6IGJvb2xlYW47XG4gIGlzU2VuZGluZzogYm9vbGVhbjtcbiAgaXNPbmxpbmU6IGJvb2xlYW47XG4gIG90aGVyVXNlclR5cGluZzogYm9vbGVhbjtcbiAgdHlwaW5nVXNlcnM6IHN0cmluZ1tdO1xuICBlcnJvcjogc3RyaW5nIHwgbnVsbDtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBDaGF0QWN0aW9ucyB7XG4gIHNlbmRNZXNzYWdlOiAoY29udGVudDogc3RyaW5nLCByZXBseVRvPzogeyBfaWQ6IHN0cmluZzsgYXV0aG9yPzogc3RyaW5nOyB0ZXh0Pzogc3RyaW5nIH0pID0+IFByb21pc2U8dm9pZD47XG4gIGxvYWRNZXNzYWdlczogKCkgPT4gUHJvbWlzZTx2b2lkPjtcbiAgcmV0cnlNZXNzYWdlOiAobWVzc2FnZUlkOiBzdHJpbmcpID0+IFByb21pc2U8dm9pZD47XG4gIG1hcmtBc1JlYWQ6ICgpID0+IFByb21pc2U8dm9pZD47XG4gIGNsZWFyRXJyb3I6ICgpID0+IHZvaWQ7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgVXNlQ2hhdERhdGFSZXR1cm4ge1xuICBkYXRhOiBDaGF0RGF0YTtcbiAgYWN0aW9uczogQ2hhdEFjdGlvbnM7XG59XG5cbmNvbnN0IE1BWF9NRVNTQUdFX0xFTkdUSCA9IDUwMDtcbmNvbnN0IFRZUElOR19USU1FT1VUID0gMjAwMDtcbmNvbnN0IE1FU1NBR0VfQkFUQ0hfU0laRSA9IDIwO1xuXG5leHBvcnQgZnVuY3Rpb24gdXNlQ2hhdERhdGEobWF0Y2hJZDogc3RyaW5nKTogVXNlQ2hhdERhdGFSZXR1cm4ge1xuICBjb25zdCB7IHVzZXIgfSA9IHVzZUF1dGhTdG9yZSgpO1xuXG4gIC8vIFN0YXRlXG4gIGNvbnN0IFttZXNzYWdlcywgc2V0TWVzc2FnZXNdID0gdXNlU3RhdGU8TWVzc2FnZVtdPihbXSk7XG4gIGNvbnN0IFtpc0xvYWRpbmcsIHNldElzTG9hZGluZ10gPSB1c2VTdGF0ZSh0cnVlKTtcbiAgY29uc3QgW2lzU2VuZGluZywgc2V0SXNTZW5kaW5nXSA9IHVzZVN0YXRlKGZhbHNlKTtcbiAgY29uc3QgW2lzT25saW5lLCBzZXRJc09ubGluZV0gPSB1c2VTdGF0ZSh0cnVlKTtcbiAgY29uc3QgW290aGVyVXNlclR5cGluZywgc2V0T3RoZXJVc2VyVHlwaW5nXSA9IHVzZVN0YXRlKGZhbHNlKTtcbiAgY29uc3QgW3R5cGluZ1VzZXJzLCBzZXRUeXBpbmdVc2Vyc10gPSB1c2VTdGF0ZTxzdHJpbmdbXT4oW10pO1xuICBjb25zdCBbZXJyb3IsIHNldEVycm9yXSA9IHVzZVN0YXRlPHN0cmluZyB8IG51bGw+KG51bGwpO1xuXG4gIC8vIFJlZnNcbiAgY29uc3QgdHlwaW5nVGltZW91dFJlZiA9IHVzZVJlZjxOb2RlSlMuVGltZW91dCB8IG51bGw+KG51bGwpO1xuICBjb25zdCBzb2NrZXQgPSB1c2VTb2NrZXQoKTtcblxuICAvLyBTZXR1cCBzb2NrZXQgY29ubmVjdGlvbiBhbmQgZXZlbnQgbGlzdGVuZXJzXG4gIHVzZUVmZmVjdCgoKSA9PiB7XG4gICAgaWYgKCFzb2NrZXQpIHtcbiAgICAgIGxvZ2dlci5kZWJ1ZyhcIlNvY2tldCBub3QgYXZhaWxhYmxlIHlldFwiLCB7IG1hdGNoSWQgfSk7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgbG9nZ2VyLmluZm8oXCJTb2NrZXQgY29ubmVjdGVkIGZvciBjaGF0XCIsIHsgbWF0Y2hJZCwgc29ja2V0SWQ6IHNvY2tldC5pZCB9KTtcblxuICAgIC8vIFNldCB1cCBldmVudCBsaXN0ZW5lcnNcbiAgICBjb25zdCBoYW5kbGVOZXdNZXNzYWdlID0gKG1lc3NhZ2U6IE1lc3NhZ2UpID0+IHtcbiAgICAgIGxvZ2dlci5kZWJ1ZyhcIk5ldyBtZXNzYWdlIHJlY2VpdmVkIHZpYSBzb2NrZXRcIiwgeyBtZXNzYWdlIH0pO1xuICAgICAgc2V0TWVzc2FnZXMoKHByZXYpID0+IFsuLi5wcmV2LCBtZXNzYWdlXSk7XG4gICAgfTtcblxuICAgIGNvbnN0IGhhbmRsZVVzZXJUeXBpbmcgPSAoZGF0YToge1xuICAgICAgbWF0Y2hJZDogc3RyaW5nO1xuICAgICAgdXNlcklkOiBzdHJpbmc7XG4gICAgICBpc1R5cGluZzogYm9vbGVhbjtcbiAgICB9KSA9PiB7XG4gICAgICBpZiAoZGF0YS5tYXRjaElkID09PSBtYXRjaElkKSB7XG4gICAgICAgIHNldE90aGVyVXNlclR5cGluZyhkYXRhLmlzVHlwaW5nKTtcbiAgICAgICAgaWYgKGRhdGEuaXNUeXBpbmcpIHtcbiAgICAgICAgICBzZXRUeXBpbmdVc2VycygocHJldikgPT4gWy4uLm5ldyBTZXQoWy4uLnByZXYsIGRhdGEudXNlcklkXSldKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBzZXRUeXBpbmdVc2VycygocHJldikgPT4gcHJldi5maWx0ZXIoKGlkKSA9PiBpZCAhPT0gZGF0YS51c2VySWQpKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH07XG5cbiAgICBjb25zdCBoYW5kbGVVc2VyT25saW5lID0gKGRhdGE6IHsgdXNlcklkOiBzdHJpbmcgfSkgPT4ge1xuICAgICAgc2V0SXNPbmxpbmUodHJ1ZSk7XG4gICAgICBsb2dnZXIuZGVidWcoXCJVc2VyIGNhbWUgb25saW5lXCIsIHsgZGF0YSB9KTtcbiAgICB9O1xuXG4gICAgY29uc3QgaGFuZGxlVXNlck9mZmxpbmUgPSAoZGF0YTogeyB1c2VySWQ6IHN0cmluZyB9KSA9PiB7XG4gICAgICBzZXRJc09ubGluZShmYWxzZSk7XG4gICAgICBsb2dnZXIuZGVidWcoXCJVc2VyIHdlbnQgb2ZmbGluZVwiLCB7IGRhdGEgfSk7XG4gICAgfTtcblxuICAgIC8vIFJlZ2lzdGVyIGV2ZW50IGxpc3RlbmVyc1xuICAgIHNvY2tldC5vbihcIm5ld19tZXNzYWdlXCIsIGhhbmRsZU5ld01lc3NhZ2UpO1xuICAgIHNvY2tldC5vbihcInR5cGluZ1wiLCBoYW5kbGVVc2VyVHlwaW5nKTtcbiAgICBzb2NrZXQub24oXCJ1c2VyX29ubGluZVwiLCBoYW5kbGVVc2VyT25saW5lKTtcbiAgICBzb2NrZXQub24oXCJ1c2VyX29mZmxpbmVcIiwgaGFuZGxlVXNlck9mZmxpbmUpO1xuXG4gICAgLy8gSm9pbiB0aGUgbWF0Y2ggcm9vbVxuICAgIHNvY2tldC5lbWl0KFwiam9pbl9tYXRjaFwiLCB7IG1hdGNoSWQgfSk7XG5cbiAgICAvLyBDbGVhbnVwIG9uIHVubW91bnRcbiAgICByZXR1cm4gKCkgPT4ge1xuICAgICAgbG9nZ2VyLmRlYnVnKFwiQ2xlYW5pbmcgdXAgc29ja2V0IGxpc3RlbmVyc1wiLCB7IG1hdGNoSWQgfSk7XG4gICAgICBzb2NrZXQub2ZmKFwibmV3X21lc3NhZ2VcIiwgaGFuZGxlTmV3TWVzc2FnZSk7XG4gICAgICBzb2NrZXQub2ZmKFwidHlwaW5nXCIsIGhhbmRsZVVzZXJUeXBpbmcpO1xuICAgICAgc29ja2V0Lm9mZihcInVzZXJfb25saW5lXCIsIGhhbmRsZVVzZXJPbmxpbmUpO1xuICAgICAgc29ja2V0Lm9mZihcInVzZXJfb2ZmbGluZVwiLCBoYW5kbGVVc2VyT2ZmbGluZSk7XG4gICAgICBzb2NrZXQuZW1pdChcImxlYXZlX21hdGNoXCIsIHsgbWF0Y2hJZCB9KTtcbiAgICB9O1xuICB9LCBbc29ja2V0LCBtYXRjaElkXSk7XG5cbiAgLy8gSGVscGVyIHRvIGNvbnZlcnQgY29yZSBNZXNzYWdlIHRvIGxvY2FsIE1lc3NhZ2UgZm9ybWF0XG4gIGNvbnN0IGNvbnZlcnRNZXNzYWdlID0gdXNlQ2FsbGJhY2soKGNvcmVNc2c6IENvcmVNZXNzYWdlKTogTWVzc2FnZSA9PiB7XG4gICAgY29uc3Qgc2VuZGVySWQgPSB0eXBlb2YgY29yZU1zZy5zZW5kZXIgPT09ICdzdHJpbmcnID8gY29yZU1zZy5zZW5kZXIgOiBjb3JlTXNnLnNlbmRlci5faWQ7XG4gICAgcmV0dXJuIHtcbiAgICAgIF9pZDogY29yZU1zZy5faWQsXG4gICAgICBjb250ZW50OiBjb3JlTXNnLmNvbnRlbnQsXG4gICAgICBzZW5kZXJJZCxcbiAgICAgIHRpbWVzdGFtcDogY29yZU1zZy5zZW50QXQsXG4gICAgICByZWFkOiBjb3JlTXNnLnJlYWRCeS5sZW5ndGggPiAwLFxuICAgICAgdHlwZTogY29yZU1zZy5tZXNzYWdlVHlwZSA9PT0gJ3RleHQnID8gJ3RleHQnIDogXG4gICAgICAgICAgICBjb3JlTXNnLm1lc3NhZ2VUeXBlID09PSAnaW1hZ2UnID8gJ2ltYWdlJyA6XG4gICAgICAgICAgICBjb3JlTXNnLm1lc3NhZ2VUeXBlID09PSAndm9pY2UnID8gJ3ZvaWNlJyA6ICd0ZXh0JyxcbiAgICAgIHJlcGx5VG86IGNvcmVNc2cucmVwbHlUbyxcbiAgICAgIGVycm9yOiBmYWxzZSxcbiAgICB9O1xuICB9LCBbXSk7XG5cbiAgLy8gTG9hZCBtZXNzYWdlcyBmcm9tIEFQSVxuICBjb25zdCBsb2FkTWVzc2FnZXMgPSB1c2VDYWxsYmFjayhhc3luYyAoKTogUHJvbWlzZTx2b2lkPiA9PiB7XG4gICAgdHJ5IHtcbiAgICAgIHNldElzTG9hZGluZyh0cnVlKTtcbiAgICAgIHNldEVycm9yKG51bGwpO1xuXG4gICAgICBjb25zdCBjb3JlTWVzc2FnZXMgPSBhd2FpdCBtYXRjaGVzQVBJLmdldE1lc3NhZ2VzKG1hdGNoSWQpO1xuXG4gICAgICBpZiAoY29yZU1lc3NhZ2VzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgY29uc3QgY29udmVydGVkTWVzc2FnZXMgPSBjb3JlTWVzc2FnZXMubWFwKGNvbnZlcnRNZXNzYWdlKTtcbiAgICAgICAgc2V0TWVzc2FnZXMoY29udmVydGVkTWVzc2FnZXMpO1xuICAgICAgICBhd2FpdCBtYXJrQXNSZWFkKCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBzZXRNZXNzYWdlcyhbXSk7XG4gICAgICB9XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBjb25zdCBlcnJvck1lc3NhZ2UgPVxuICAgICAgICBcIkZhaWxlZCB0byBsb2FkIG1lc3NhZ2VzLiBQbGVhc2UgY2hlY2sgeW91ciBjb25uZWN0aW9uIGFuZCB0cnkgYWdhaW4uXCI7XG4gICAgICBsb2dnZXIuZXJyb3IoXCJGYWlsZWQgdG8gbG9hZCBtZXNzYWdlc1wiLCB7IGVycm9yOiBlcnIgaW5zdGFuY2VvZiBFcnJvciA/IGVyciA6IG5ldyBFcnJvcihTdHJpbmcoZXJyKSksIG1hdGNoSWQgfSk7XG4gICAgICBzZXRFcnJvcihlcnJvck1lc3NhZ2UpO1xuICAgICAgQWxlcnQuYWxlcnQoXCJDb25uZWN0aW9uIEVycm9yXCIsIGVycm9yTWVzc2FnZSk7XG4gICAgfSBmaW5hbGx5IHtcbiAgICAgIHNldElzTG9hZGluZyhmYWxzZSk7XG4gICAgfVxuICB9LCBbbWF0Y2hJZCwgY29udmVydE1lc3NhZ2VdKTtcblxuICAvLyBTZW5kIG1lc3NhZ2Ugd2l0aCBvcHRpbWlzdGljIHVwZGF0ZXNcbiAgY29uc3Qgc2VuZE1lc3NhZ2UgPSB1c2VDYWxsYmFjayhcbiAgICBhc3luYyAoY29udGVudDogc3RyaW5nLCByZXBseVRvPzogeyBfaWQ6IHN0cmluZzsgYXV0aG9yPzogc3RyaW5nOyB0ZXh0Pzogc3RyaW5nIH0pOiBQcm9taXNlPHZvaWQ+ID0+IHtcbiAgICAgIGlmICghY29udGVudC50cmltKCkgfHwgaXNTZW5kaW5nKSByZXR1cm47XG5cbiAgICAgIGNvbnN0IG1lc3NhZ2VDb250ZW50ID0gY29udGVudC50cmltKCk7XG4gICAgICBjb25zdCB0ZW1wSWQgPSBgdGVtcF8ke0RhdGUubm93KCl9YDtcblxuICAgICAgLy8gT3B0aW1pc3RpYyBVSSB1cGRhdGVcbiAgICAgIGNvbnN0IG9wdGltaXN0aWNNZXNzYWdlOiBNZXNzYWdlID0ge1xuICAgICAgICBfaWQ6IHRlbXBJZCxcbiAgICAgICAgY29udGVudDogbWVzc2FnZUNvbnRlbnQsXG4gICAgICAgIHNlbmRlcklkOiB1c2VyPy5faWQgPz8gXCJtZVwiLFxuICAgICAgICB0aW1lc3RhbXA6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSxcbiAgICAgICAgcmVhZDogZmFsc2UsXG4gICAgICAgIHR5cGU6IFwidGV4dFwiLFxuICAgICAgICBzdGF0dXM6IFwic2VuZGluZ1wiLFxuICAgICAgICByZXBseVRvOiByZXBseVRvID8geyBfaWQ6IHJlcGx5VG8uX2lkLCBhdXRob3I6IHJlcGx5VG8uYXV0aG9yLCB0ZXh0OiByZXBseVRvLnRleHQgfSA6IHVuZGVmaW5lZCxcbiAgICAgIH07XG5cbiAgICAgIHNldElzU2VuZGluZyh0cnVlKTtcbiAgICAgIHNldE1lc3NhZ2VzKChwcmV2KSA9PiBbLi4ucHJldiwgb3B0aW1pc3RpY01lc3NhZ2VdKTtcblxuICAgICAgdHJ5IHtcbiAgICAgICAgY29uc3Qgc2VudE1lc3NhZ2UgPSBhd2FpdCBtYXRjaGVzQVBJLnNlbmRNZXNzYWdlKFxuICAgICAgICAgIG1hdGNoSWQsXG4gICAgICAgICAgbWVzc2FnZUNvbnRlbnQsXG4gICAgICAgICAgcmVwbHlUbyxcbiAgICAgICAgKTtcblxuICAgICAgICAvLyBDb252ZXJ0IGFuZCByZXBsYWNlIG9wdGltaXN0aWMgbWVzc2FnZSB3aXRoIHNlcnZlciByZXNwb25zZVxuICAgICAgICBjb25zdCBjb252ZXJ0ZWRTZW50TWVzc2FnZSA9IGNvbnZlcnRNZXNzYWdlKHNlbnRNZXNzYWdlKTtcbiAgICAgICAgc2V0TWVzc2FnZXMoKHByZXYpID0+XG4gICAgICAgICAgcHJldi5tYXAoXG4gICAgICAgICAgICAobXNnKTogTWVzc2FnZSA9PlxuICAgICAgICAgICAgICBtc2cuX2lkID09PSB0ZW1wSWQgPyB7IC4uLmNvbnZlcnRlZFNlbnRNZXNzYWdlLCBzdGF0dXM6IFwic2VudFwiIH0gOiBtc2csXG4gICAgICAgICAgKSxcbiAgICAgICAgKTtcblxuICAgICAgICAvLyBFbWl0IHRvIHNvY2tldCBmb3IgcmVhbC10aW1lIHVwZGF0ZXNcbiAgICAgICAgaWYgKHNvY2tldCAmJiBzb2NrZXQuY29ubmVjdGVkKSB7XG4gICAgICAgICAgc29ja2V0LmVtaXQoXCJzZW5kX21lc3NhZ2VcIiwgc2VudE1lc3NhZ2UpO1xuICAgICAgICAgIHNvY2tldC5lbWl0KFwidHlwaW5nXCIsIHtcbiAgICAgICAgICAgIG1hdGNoSWQsXG4gICAgICAgICAgICB1c2VySWQ6IHVzZXI/Ll9pZCxcbiAgICAgICAgICAgIGlzVHlwaW5nOiBmYWxzZSxcbiAgICAgICAgICB9KTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIFNpbXVsYXRlIHJlYWxpc3RpYyByZXNwb25zZSBmb3IgZGVtb1xuICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgICBzZXRPdGhlclVzZXJUeXBpbmcodHJ1ZSk7XG4gICAgICAgICAgc2V0VGltZW91dChcbiAgICAgICAgICAgICgpID0+IHtcbiAgICAgICAgICAgICAgc2V0T3RoZXJVc2VyVHlwaW5nKGZhbHNlKTtcbiAgICAgICAgICAgICAgY29uc3QgcmVzcG9uc2U6IE1lc3NhZ2UgPSB7XG4gICAgICAgICAgICAgICAgX2lkOiBgcmVzcG9uc2VfJHtEYXRlLm5vdygpfWAsXG4gICAgICAgICAgICAgICAgY29udGVudDogZ2V0SW50ZWxsaWdlbnRSZXNwb25zZShtZXNzYWdlQ29udGVudCksXG4gICAgICAgICAgICAgICAgc2VuZGVySWQ6IFwib3RoZXJcIixcbiAgICAgICAgICAgICAgICB0aW1lc3RhbXA6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSxcbiAgICAgICAgICAgICAgICByZWFkOiBmYWxzZSxcbiAgICAgICAgICAgICAgICB0eXBlOiBcInRleHRcIixcbiAgICAgICAgICAgICAgfTtcblxuICAgICAgICAgICAgICBzZXRNZXNzYWdlcygocHJldikgPT4gWy4uLnByZXYsIHJlc3BvbnNlXSk7XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgMTUwMCArIE1hdGgucmFuZG9tKCkgKiAxMDAwLFxuICAgICAgICAgICk7XG4gICAgICAgIH0sIDgwMCk7XG4gICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgbG9nZ2VyLmVycm9yKFwiRmFpbGVkIHRvIHNlbmQgbWVzc2FnZVwiLCB7XG4gICAgICAgICAgZXJyb3I6IGVyciBpbnN0YW5jZW9mIEVycm9yID8gZXJyIDogbmV3IEVycm9yKFN0cmluZyhlcnIpKSxcbiAgICAgICAgICBtYXRjaElkLFxuICAgICAgICAgIGNvbnRlbnQsXG4gICAgICAgIH0pO1xuXG4gICAgICAgIC8vIFNob3cgZXJyb3Igc3RhdGVcbiAgICAgICAgc2V0TWVzc2FnZXMoKHByZXYpID0+XG4gICAgICAgICAgcHJldi5tYXAoKG1zZykgPT5cbiAgICAgICAgICAgIG1zZy5faWQgPT09IHRlbXBJZFxuICAgICAgICAgICAgICA/IHsgLi4ubXNnLCBzdGF0dXM6IFwiZmFpbGVkXCIsIGVycm9yOiB0cnVlIH1cbiAgICAgICAgICAgICAgOiBtc2csXG4gICAgICAgICAgKSxcbiAgICAgICAgKTtcblxuICAgICAgICBzZXRFcnJvcihcIkZhaWxlZCB0byBzZW5kIG1lc3NhZ2UuIFBsZWFzZSB0cnkgYWdhaW4uXCIpO1xuICAgICAgfSBmaW5hbGx5IHtcbiAgICAgICAgc2V0SXNTZW5kaW5nKGZhbHNlKTtcbiAgICAgIH1cbiAgICB9LFxuICAgIFtpc1NlbmRpbmcsIHVzZXI/Ll9pZCwgbWF0Y2hJZF0sXG4gICk7XG5cbiAgLy8gUmV0cnkgZmFpbGVkIG1lc3NhZ2VcbiAgY29uc3QgcmV0cnlNZXNzYWdlID0gdXNlQ2FsbGJhY2soXG4gICAgYXN5bmMgKG1lc3NhZ2VJZDogc3RyaW5nKTogUHJvbWlzZTx2b2lkPiA9PiB7XG4gICAgICBjb25zdCBtZXNzYWdlID0gbWVzc2FnZXMuZmluZCgobXNnKSA9PiBtc2cuX2lkID09PSBtZXNzYWdlSWQpO1xuICAgICAgaWYgKCFtZXNzYWdlKSByZXR1cm47XG5cbiAgICAgIGNvbnN0IHJldHJ5TWVzc2FnZTogTWVzc2FnZSA9IHtcbiAgICAgICAgLi4ubWVzc2FnZSxcbiAgICAgICAgX2lkOiBgcmV0cnlfJHtEYXRlLm5vdygpfWAsXG4gICAgICAgIHN0YXR1czogXCJzZW5kaW5nXCIsXG4gICAgICAgIGVycm9yOiBmYWxzZSxcbiAgICAgIH07XG5cbiAgICAgIHNldE1lc3NhZ2VzKChwcmV2KSA9PlxuICAgICAgICBwcmV2Lm1hcCgobXNnKSA9PiAobXNnLl9pZCA9PT0gbWVzc2FnZUlkID8gcmV0cnlNZXNzYWdlIDogbXNnKSksXG4gICAgICApO1xuXG4gICAgICB0cnkge1xuICAgICAgICBhd2FpdCBtYXRjaGVzQVBJLnNlbmRNZXNzYWdlKG1hdGNoSWQsIG1lc3NhZ2UuY29udGVudCk7XG4gICAgICAgIHNldE1lc3NhZ2VzKChwcmV2KSA9PlxuICAgICAgICAgIHByZXYubWFwKChtc2cpID0+XG4gICAgICAgICAgICBtc2cuX2lkID09PSByZXRyeU1lc3NhZ2UuX2lkXG4gICAgICAgICAgICAgID8geyAuLi5tc2csIHN0YXR1czogXCJzZW50XCIsIGVycm9yOiBmYWxzZSB9XG4gICAgICAgICAgICAgIDogbXNnLFxuICAgICAgICAgICksXG4gICAgICAgICk7XG4gICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgbG9nZ2VyLmVycm9yKFwiRmFpbGVkIHRvIHJldHJ5IG1lc3NhZ2VcIiwgeyBlcnJvcjogZXJyIGluc3RhbmNlb2YgRXJyb3IgPyBlcnIgOiBuZXcgRXJyb3IoU3RyaW5nKGVycikpLCBtZXNzYWdlSWQgfSk7XG4gICAgICAgIHNldE1lc3NhZ2VzKChwcmV2KSA9PlxuICAgICAgICAgIHByZXYubWFwKChtc2cpID0+XG4gICAgICAgICAgICBtc2cuX2lkID09PSByZXRyeU1lc3NhZ2UuX2lkXG4gICAgICAgICAgICAgID8geyAuLi5tc2csIHN0YXR1czogXCJmYWlsZWRcIiwgZXJyb3I6IHRydWUgfVxuICAgICAgICAgICAgICA6IG1zZyxcbiAgICAgICAgICApLFxuICAgICAgICApO1xuICAgICAgfVxuICAgIH0sXG4gICAgW21lc3NhZ2VzLCBtYXRjaElkXSxcbiAgKTtcblxuICAvLyBNYXJrIG1lc3NhZ2VzIGFzIHJlYWRcbiAgY29uc3QgbWFya0FzUmVhZCA9IHVzZUNhbGxiYWNrKGFzeW5jICgpOiBQcm9taXNlPHZvaWQ+ID0+IHtcbiAgICB0cnkge1xuICAgICAgLy8gQVBJIGNhbGwgd291bGQgYmUgaW1wbGVtZW50ZWQgaGVyZSBpZiBlbmRwb2ludCBleGlzdHNcbiAgICAgIGxvZ2dlci5kZWJ1ZyhcIk1lc3NhZ2VzIG1hcmtlZCBhcyByZWFkXCIsIHsgbWF0Y2hJZCB9KTtcbiAgICAgIHNldE1lc3NhZ2VzKChwcmV2KSA9PiBwcmV2Lm1hcCgobXNnKSA9PiAoeyAuLi5tc2csIHJlYWQ6IHRydWUgfSkpKTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIGxvZ2dlci5lcnJvcihcIkZhaWxlZCB0byBtYXJrIG1lc3NhZ2VzIGFzIHJlYWRcIiwgeyBlcnJvcjogZXJyIGluc3RhbmNlb2YgRXJyb3IgPyBlcnIgOiBuZXcgRXJyb3IoU3RyaW5nKGVycikpLCBtYXRjaElkIH0pO1xuICAgIH1cbiAgfSwgW21hdGNoSWRdKTtcblxuICAvLyBDbGVhciBlcnJvciBzdGF0ZVxuICBjb25zdCBjbGVhckVycm9yID0gdXNlQ2FsbGJhY2soKCk6IHZvaWQgPT4ge1xuICAgIHNldEVycm9yKG51bGwpO1xuICB9LCBbXSk7XG5cbiAgLy8gTG9hZCBtZXNzYWdlcyBvbiBtb3VudFxuICB1c2VFZmZlY3QoKCkgPT4ge1xuICAgIGxvYWRNZXNzYWdlcygpO1xuICB9LCBbbG9hZE1lc3NhZ2VzXSk7XG5cbiAgLy8gQ2xlYW51cCBvbiB1bm1vdW50XG4gIHVzZUVmZmVjdCgoKSA9PiB7XG4gICAgcmV0dXJuICgpID0+IHtcbiAgICAgIGlmICh0eXBpbmdUaW1lb3V0UmVmLmN1cnJlbnQpIHtcbiAgICAgICAgY2xlYXJUaW1lb3V0KHR5cGluZ1RpbWVvdXRSZWYuY3VycmVudCk7XG4gICAgICB9XG4gICAgfTtcbiAgfSwgW10pO1xuXG4gIHJldHVybiB7XG4gICAgZGF0YToge1xuICAgICAgbWVzc2FnZXMsXG4gICAgICBpc0xvYWRpbmcsXG4gICAgICBpc1NlbmRpbmcsXG4gICAgICBpc09ubGluZSxcbiAgICAgIG90aGVyVXNlclR5cGluZyxcbiAgICAgIHR5cGluZ1VzZXJzLFxuICAgICAgZXJyb3IsXG4gICAgfSxcbiAgICBhY3Rpb25zOiB7XG4gICAgICBzZW5kTWVzc2FnZSxcbiAgICAgIGxvYWRNZXNzYWdlcyxcbiAgICAgIHJldHJ5TWVzc2FnZSxcbiAgICAgIG1hcmtBc1JlYWQsXG4gICAgICBjbGVhckVycm9yLFxuICAgIH0sXG4gIH07XG59XG5cbi8vIEludGVsbGlnZW50IHJlc3BvbnNlIGdlbmVyYXRpb24gYmFzZWQgb24gbWVzc2FnZSBjb250ZW50XG5mdW5jdGlvbiBnZXRJbnRlbGxpZ2VudFJlc3BvbnNlKG1lc3NhZ2VDb250ZW50OiBzdHJpbmcpOiBzdHJpbmcge1xuICBjb25zdCBjb250ZW50ID0gbWVzc2FnZUNvbnRlbnQudG9Mb3dlckNhc2UoKTtcblxuICBpZiAoXG4gICAgY29udGVudC5pbmNsdWRlcyhcIndlZWtlbmRcIikgfHxcbiAgICBjb250ZW50LmluY2x1ZGVzKFwic2F0dXJkYXlcIikgfHxcbiAgICBjb250ZW50LmluY2x1ZGVzKFwic3VuZGF5XCIpXG4gICkge1xuICAgIHJldHVybiBcIldlZWtlbmRzIHdvcmsgcGVyZmVjdGx5IGZvciBtZSEgTXkgc2NoZWR1bGUgaXMgcHJldHR5IGZsZXhpYmxlIHRoZW4g8J+ThVwiO1xuICB9XG4gIGlmIChjb250ZW50LmluY2x1ZGVzKFwicGFya1wiKSB8fCBjb250ZW50LmluY2x1ZGVzKFwiZG9nIHBhcmtcIikpIHtcbiAgICByZXR1cm4gXCJUaGUgZG9nIHBhcmsgc291bmRzIGFtYXppbmchIE15IHB1cCBhYnNvbHV0ZWx5IGxvdmVzIG1lZXRpbmcgbmV3IGZyaWVuZHMgdGhlcmUg8J+Ms/CfkJVcIjtcbiAgfVxuICBpZiAoY29udGVudC5pbmNsdWRlcyhcInRpbWVcIikgfHwgY29udGVudC5pbmNsdWRlcyhcIndoZW5cIikpIHtcbiAgICByZXR1cm4gXCJJJ20gcHJldHR5IGZsZXhpYmxlIHdpdGggdGltaW5nISBXaGF0IHdvcmtzIGJlc3QgZm9yIHlvdXIgc2NoZWR1bGU/IOKPsFwiO1xuICB9XG4gIGlmIChcbiAgICBjb250ZW50LmluY2x1ZGVzKFwid2VhdGhlclwiKSB8fFxuICAgIGNvbnRlbnQuaW5jbHVkZXMoXCJzdW5ueVwiKSB8fFxuICAgIGNvbnRlbnQuaW5jbHVkZXMoXCJwZXJmZWN0XCIpXG4gICkge1xuICAgIHJldHVybiBcIlllcyEgSSBjaGVja2VkIHRoZSBmb3JlY2FzdCB0b28gLSBpdCdzIGdvaW5nIHRvIGJlIGJlYXV0aWZ1bCEgUGVyZmVjdCBkYXkgZm9yIG91ciBwZXRzIHRvIHBsYXkg4piA77iPXCI7XG4gIH1cbiAgaWYgKFxuICAgIGNvbnRlbnQuaW5jbHVkZXMoXCJleGNpdGVkXCIpIHx8XG4gICAgY29udGVudC5pbmNsdWRlcyhcImNhbid0IHdhaXRcIikgfHxcbiAgICBjb250ZW50LmluY2x1ZGVzKFwibG9va2luZyBmb3J3YXJkXCIpXG4gICkge1xuICAgIHJldHVybiBcIk1lIHRvbyEgVGhpcyBpcyBnb2luZyB0byBiZSBzbyBtdWNoIGZ1bi4gSSB0aGluayBvdXIgcGV0cyBhcmUgZ29pbmcgdG8gYmUgYmVzdCBmcmllbmRzISDwn5C+8J+SlVwiO1xuICB9XG4gIGlmIChcbiAgICBjb250ZW50LmluY2x1ZGVzKFwicGhvdG9cIikgfHxcbiAgICBjb250ZW50LmluY2x1ZGVzKFwicGljdHVyZVwiKSB8fFxuICAgIGNvbnRlbnQuaW5jbHVkZXMoXCJwaWNcIilcbiAgKSB7XG4gICAgcmV0dXJuIFwiSSdkIGxvdmUgdG8gc2VlIG1vcmUgcGhvdG9zISBZb3VyIHBldCBpcyBhYnNvbHV0ZWx5IGFkb3JhYmxlIPCfk7jinKhcIjtcbiAgfVxuXG4gIC8vIERlZmF1bHQgY29udGV4dHVhbCByZXNwb25zZXNcbiAgY29uc3QgcmVzcG9uc2VzOiBzdHJpbmdbXSA9IFtcbiAgICBcIlRoYXQgc291bmRzIGFic29sdXRlbHkgcGVyZmVjdCEgSSdtIHJlYWxseSBsb29raW5nIGZvcndhcmQgdG8gaXQg8J+OvlwiLFxuICAgIFwiQW1hemluZyEgTXkgcGV0IGlzIGdvaW5nIHRvIGJlIHNvIGV4Y2l0ZWQgdG8gbWVldCB5b3VycyDwn5CV8J+SlVwiLFxuICAgIFwiUGVyZmVjdCEgSSB0aGluayB0aGlzIGlzIGdvaW5nIHRvIGJlIHRoZSBzdGFydCBvZiBhIGJlYXV0aWZ1bCBmcmllbmRzaGlwIPCfmIpcIixcbiAgICBcIldvbmRlcmZ1bCEgSSBjYW4gYWxyZWFkeSB0ZWxsIG91ciBwZXRzIGFyZSBnb2luZyB0byBnZXQgYWxvbmcgZ3JlYXQg8J+Mn1wiLFxuICAgIFwiRmFudGFzdGljISBUaGlzIGlzIGV4YWN0bHkgd2hhdCBJIHdhcyBob3BpbmcgZm9yIPCfjolcIixcbiAgICBcIkxvdmUgaXQhIEkgaGF2ZSBhIHJlYWxseSBnb29kIGZlZWxpbmcgYWJvdXQgdGhpcyBwbGF5ZGF0ZSDinKhcIixcbiAgXTtcbiAgY29uc3QgcmFuZG9tSW5kZXggPSBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiByZXNwb25zZXMubGVuZ3RoKTtcbiAgcmV0dXJuIHJlc3BvbnNlc1tyYW5kb21JbmRleF0gPz8gXCJTb3VuZHMgZ3JlYXQhXCI7XG59XG4iXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBQUEsSUFBQUEsTUFBQSxHQUFBQyxPQUFBO0FBRUEsSUFBQUMsWUFBQSxHQUFBRCxPQUFBO0FBQ0EsSUFBQUUsS0FBQSxHQUFBRixPQUFBO0FBRUEsSUFBQUcsT0FBQSxHQUFBSCxPQUFBO0FBQ0EsSUFBQUksSUFBQSxHQUFBSixPQUFBO0FBQ0EsSUFBQUssVUFBQSxHQUFBTCxPQUFBO0FBQXdDLFNBQUFNLFFBQUFDLENBQUEsRUFBQUMsQ0FBQSxRQUFBQyxDQUFBLEdBQUFDLE1BQUEsQ0FBQUMsSUFBQSxDQUFBSixDQUFBLE9BQUFH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