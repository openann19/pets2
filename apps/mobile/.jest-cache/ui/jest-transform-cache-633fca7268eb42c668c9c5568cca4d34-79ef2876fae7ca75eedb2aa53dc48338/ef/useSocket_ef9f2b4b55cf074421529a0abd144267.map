{"version":3,"names":["_core","require","_react","_socket","useSocket","_useState","useState","_useState2","_slicedToArray2","default","socket","setSocket","_useState3","_useState4","_isConnected","setIsConnected","_useState5","_useState6","error","setError","_useAuthStore","useAuthStore","user","accessToken","reconnectAttempts","useRef","maxReconnectAttempts","useEffect","connectSocket","socketUrl","process","env","newSocket","io","auth","token","userId","_id","transports","timeout","reconnection","reconnectionAttempts","reconnectionDelay","on","logger","info","socketId","id","current","reason","connect","err","message","_err","disconnect","data","socketInstance","removeAllListeners","useSocketWithStatus","_useState7","_useState8","_useState9","_useState0","isConnected","_useState1","_useState10","_useAuthStore2","useSocketEmit","emit","event","connected","warn","_default","exports"],"sources":["useSocket.ts"],"sourcesContent":["import { useAuthStore } from \"@pawfectmatch/core\";\nimport { logger } from \"@pawfectmatch/core\";\nimport { useEffect, useState, useRef } from \"react\";\nimport type { Socket } from \"socket.io-client\";\nimport { io } from \"socket.io-client\";\nimport type {\n  UserTypingEvent,\n  NewMessageEvent,\n  UserStatusEvent,\n  OnlineUsersUpdate,\n} from \"@pawfectmatch/core\";\n\ninterface UseSocketReturn {\n  socket: Socket | null;\n  isConnected: boolean;\n  error: string | null;\n}\n\nexport function useSocket(): Socket | null {\n  const [socket, setSocket] = useState<Socket | null>(null);\n  const [_isConnected, setIsConnected] = useState(false);\n  const [error, setError] = useState<string | null>(null);\n  const { user, accessToken } = useAuthStore();\n  const reconnectAttempts = useRef(0);\n  const maxReconnectAttempts = 5;\n\n  useEffect(() => {\n    if (!user || !accessToken) {\n      return;\n    }\n\n    function connectSocket(): Socket | null {\n      try {\n        const socketUrl =\n          process.env[\"EXPO_PUBLIC_SOCKET_URL\"] || \"http://localhost:3001\";\n        const newSocket = io(socketUrl, {\n          auth: {\n            token: accessToken,\n            userId: user!._id, // Non-null assertion, guarded by check above\n          },\n          transports: [\"websocket\"],\n          timeout: 10000,\n          reconnection: true,\n          reconnectionAttempts: maxReconnectAttempts,\n          reconnectionDelay: 1000,\n        });\n\n        newSocket.on(\"connect\", () => {\n          logger.info(\"Socket connected:\", { socketId: newSocket.id });\n          setIsConnected(true);\n          setError(null);\n          reconnectAttempts.current = 0;\n        });\n\n        newSocket.on(\"disconnect\", (reason: string) => {\n          logger.info(\"Socket disconnected:\", { reason });\n          setIsConnected(false);\n\n          if (reason === \"io server disconnect\") {\n            // Server disconnected, try to reconnect\n            newSocket.connect();\n          }\n        });\n\n        newSocket.on(\"connect_error\", (err: Error) => {\n          logger.error(\"Socket connection error:\", { error: err });\n          setError(err.message);\n          reconnectAttempts.current++;\n\n          if (reconnectAttempts.current >= maxReconnectAttempts) {\n            setError(\"Failed to connect after multiple attempts\");\n          }\n        });\n\n        newSocket.on(\"error\", (err: Error) => {\n          logger.error(\"Socket error:\", { error });\n          setError(err.message || \"Socket error occurred\");\n        });\n\n        // Authentication error\n        newSocket.on(\"auth_error\", (_err: Error) => {\n          logger.error(\"Socket auth error:\", { error });\n          setError(\"Authentication failed\");\n          newSocket.disconnect();\n        });\n\n        // User-specific events\n        newSocket.on(\"user_online\", (data: UserStatusEvent) => {\n          logger.info(\"User came online:\", { data });\n        });\n\n        newSocket.on(\"user_offline\", (data: UserStatusEvent) => {\n          logger.info(\"User went offline:\", { data });\n        });\n\n        // Match events\n        newSocket.on(\"new_match\", (data: NewMessageEvent) => {\n          logger.info(\"New match:\", { data });\n          // Handle new match notification\n        });\n\n        newSocket.on(\"new_message\", (data: NewMessageEvent) => {\n          logger.info(\"New message:\", { data });\n          // Handle new message notification\n        });\n\n        // Call events (handled by WebRTC service)\n        newSocket.on(\"incoming_call\", (data: OnlineUsersUpdate) => {\n          logger.info(\"Incoming call:\", { data });\n        });\n\n        setSocket(newSocket);\n\n        return newSocket;\n      } catch (err) {\n        logger.error(\"Error creating socket:\", { error });\n        setError(\"Failed to create socket connection\");\n        return null;\n      }\n    }\n\n    const socketInstance = connectSocket();\n\n    return () => {\n      if (socketInstance) {\n        logger.info(\"Cleaning up socket connection\");\n        socketInstance.removeAllListeners();\n        socketInstance.disconnect();\n      }\n      setSocket(null);\n      setIsConnected(false);\n      setError(null);\n    };\n  }, [user, accessToken]);\n\n  return socket;\n}\n\n// Hook for socket with connection status\nexport function useSocketWithStatus(): UseSocketReturn {\n  const [socket, setSocket] = useState<Socket | null>(null);\n  const [isConnected, setIsConnected] = useState(false);\n  const [error, setError] = useState<string | null>(null);\n  const { user, accessToken } = useAuthStore();\n\n  useEffect(() => {\n    if (!user || !accessToken) {\n      return;\n    }\n\n    const socketUrl =\n      process.env[\"EXPO_PUBLIC_SOCKET_URL\"] || \"http://localhost:3001\";\n    const newSocket = io(socketUrl, {\n      auth: {\n        token: accessToken,\n        userId: user._id, // Non-null assertion, guarded by check above\n      },\n      transports: [\"websocket\"],\n    });\n\n    newSocket.on(\"connect\", () => {\n      setIsConnected(true);\n      setError(null);\n    });\n\n    newSocket.on(\"disconnect\", () => {\n      setIsConnected(false);\n    });\n\n    newSocket.on(\"connect_error\", (err: Error) => {\n      setError(err.message);\n      setIsConnected(false);\n    });\n\n    setSocket(newSocket);\n\n    return () => {\n      newSocket.removeAllListeners();\n      newSocket.disconnect();\n      setSocket(null);\n      setIsConnected(false);\n      setError(null);\n    };\n  }, [user, accessToken]);\n\n  return { socket, isConnected, error };\n}\n\n// Emit helper\nexport function useSocketEmit(): (\n  event: string,\n  data?: Record<string, unknown>,\n) => boolean {\n  const socket = useSocket();\n\n  function emit(event: string, data?: Record<string, unknown>): boolean {\n    if (socket && socket.connected) {\n      socket.emit(event, data);\n      return true;\n    }\n    logger.warn(\"Socket not connected, cannot emit:\", { event });\n    return false;\n  }\n\n  return emit;\n}\n\nexport default useSocket;\n"],"mappings":"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","ignoreList":[]}