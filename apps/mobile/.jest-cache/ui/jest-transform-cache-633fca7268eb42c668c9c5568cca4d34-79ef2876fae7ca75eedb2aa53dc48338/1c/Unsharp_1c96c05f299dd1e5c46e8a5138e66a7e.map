{"version":3,"names":["FileSystem","_interopRequireWildcard","require","e","t","WeakMap","r","n","__esModule","o","i","f","__proto__","default","has","get","set","_t","hasOwnProperty","call","Object","defineProperty","getOwnPropertyDescriptor","loadSkia","_loadSkia","apply","arguments","_asyncToGenerator2","_unused","unsharpMask","_x","_unsharpMask","uri","opts","length","undefined","Skia","_opts$amount","amount","_opts$radius","radius","_opts$threshold","threshold","_opts$quality","quality","_opts$format","format","S","data","Data","fromURI","src","Image","MakeImageFromEncoded","w","width","h","height","surface","Surface","MakeSurface","canvas","getCanvas","blurSurface","blurCanvas","blurPaint","Paint","setImageFilter","ImageFilter","MakeBlur","drawImage","blurred","makeImageSnapshot","sksl","effect","RuntimeEffect","Make","shader","makeShader","makeShaderOptions","p","setShader","drawRect","XYWHRect","snap","base64","encodeToBase64","ImageFormat","JPEG","Math","round","outPath","cacheDirectory","Date","now","writeAsStringAsync","encoding","EncodingType","Base64"],"sources":["Unsharp.ts"],"sourcesContent":["/**\n * Unsharp Mask\n * Proper unsharp mask: result = original + amount * (original - gaussian(original))\n * Requires @shopify/react-native-skia; otherwise no-op passthrough.\n */\n\nimport * as FileSystem from \"expo-file-system\";\n\n/**\n * Lazy load Skia to avoid bundling if not installed\n * @shopify/react-native-skia is optional - module may not be present\n */\n// eslint-disable-next-line @typescript-eslint/no-explicit-any\nasync function loadSkia(): Promise<any> {\n  try {\n    // eslint-disable-next-line @typescript-eslint/no-var-requires, @typescript-eslint/no-explicit-any\n    return require(\"@shopify/react-native-skia\");\n  } catch {\n    return null;\n  }\n}\n\nexport interface UnsharpOpts {\n  /** Strength (0..2), default 0.5 */\n  amount?: number;\n  /** Gaussian blur radius in pixels, default 1.5 */\n  radius?: number;\n  /** Threshold (0..1) to ignore small differences, default 0.02 */\n  threshold?: number;\n  /** JPEG quality (0..1), default 1 */\n  quality?: number;\n  /** Output format */\n  format?: \"jpg\" | \"png\";\n}\n\n/**\n * Apply unsharp mask to sharpen an image\n * Uses proper high-pass filtering: result = original + amount * (original - blurred)\n * \n * @param uri - Source image URI\n * @param opts - Unsharp mask options\n * @returns URI of sharpened image, or original if Skia unavailable\n */\nexport async function unsharpMask(\n  uri: string,\n  opts: UnsharpOpts = {}\n): Promise<string> {\n  const Skia = await loadSkia();\n  \n  if (!Skia) {\n    return uri; // graceful fallback\n  }\n\n  const {\n    amount = 0.5,\n    radius = 1.5,\n    threshold = 0.02,\n    quality = 1,\n    format = \"jpg\",\n  } = opts;\n\n  const { Skia: S } = Skia;\n\n  // Load source image\n  const data = await S.Data.fromURI(uri);\n  const src = S.Image.MakeImageFromEncoded(data);\n  \n  if (!src) {\n    return uri;\n  }\n\n  const w = src.width();\n  const h = src.height();\n\n  const surface = S.Surface.MakeSurface(w, h);\n  \n  if (!surface) {\n    return uri;\n  }\n  \n  const canvas = surface.getCanvas();\n\n  // Blur original into temp surface\n  const blurSurface = S.Surface.MakeSurface(w, h);\n  \n  if (!blurSurface) {\n    return uri;\n  }\n  \n  const blurCanvas = blurSurface.getCanvas();\n  const blurPaint = S.Paint();\n  blurPaint.setImageFilter(S.ImageFilter.MakeBlur(radius, radius, \"decal\"));\n  blurCanvas.drawImage(src, 0, 0, blurPaint);\n  const blurred = blurSurface.makeImageSnapshot();\n\n  // Runtime shader to do: base + amount * clamp((base - blur), threshold)\n  // This implements the high-pass filter with threshold gating\n  const sksl = `\n    uniform shader base;\n    uniform shader blur;\n    uniform float amount;\n    uniform float threshold;\n    \n    half4 main(float2 xy) {\n      half4 b = base.eval(xy);\n      half4 g = blur.eval(xy);\n      half3 hp = b.rgb - g.rgb;              // high-pass\n      half m = max(max(abs(hp.r), abs(hp.g)), abs(hp.b));\n      half t = m > threshold ? 1.0 : 0.0;    // threshold gate\n      half3 sharp = b.rgb + (amount * hp * t);\n      return half4(clamp(sharp, 0.0, 1.0), b.a);\n    }\n  `;\n  \n  const effect = S.RuntimeEffect.Make(sksl);\n  \n  if (!effect) {\n    return uri;\n  }\n\n  // Create shader with uniforms and samplers\n  const shader = effect.makeShader(\n    // uniforms\n    { amount, threshold },\n    // children (samplers)\n    [\n      src.makeShaderOptions({}, {}),\n      blurred.makeShaderOptions({}, {}),\n    ]\n  );\n\n  const p = S.Paint();\n  p.setShader(shader);\n  canvas.drawRect(S.XYWHRect(0, 0, w, h), p);\n\n  // Export sharpened image\n  const snap = surface.makeImageSnapshot();\n  const base64 =\n    format === \"png\"\n      ? snap.encodeToBase64()\n      : snap.encodeToBase64(S.ImageFormat.JPEG, Math.round(quality * 100));\n\n  const outPath = `${FileSystem.cacheDirectory}usm_${Date.now()}.${format}`;\n  await FileSystem.writeAsStringAsync(outPath, base64, {\n    encoding: FileSystem.EncodingType.Base64,\n  });\n\n  return outPath;\n}\n\n"],"mappings":";;;;;;;;AAMA,IAAAA,UAAA,GAAAC,uBAAA,CAAAC,OAAA;AAA+C,SAAAD,wBAAAE,CAAA,EAAAC,CAAA,6BAAAC,OAAA,MAAAC,CAAA,OAAAD,OAAA,IAAAE,CAAA,OAAAF,OAAA,YAAAJ,uBAAA,YAAAA,wBAAAE,CAAA,EAAAC,CAAA,SAAAA,CAAA,IAAAD,CAAA,IAAAA,CAAA,CAAAK,UAAA,SAAAL,CAAA,MAAAM,CAAA,EAAAC,CAAA,EAAAC,CAAA,KAAAC,SAAA,QAAAC,OAAA,EAAAV,CAAA,iBAAAA,CAAA,uBAAAA,CAAA,yBAAAA,CAAA,SAAAQ,CAAA,MAAAF,CAAA,GAAAL,CAAA,GAAAG,CAAA,GAAAD,CAAA,QAAAG,CAAA,CAAAK,GAAA,CAAAX,CAAA,UAAAM,CAAA,CAAAM,GAAA,CAAAZ,CAAA,GAAAM,CAAA,CAAAO,GAAA,CAAAb,CAAA,EAAAQ,CAAA,cAAAM,EAAA,IAAAd,CAAA,gBAAAc,EAAA,OAAAC,cAAA,CAAAC,IAAA,CAAAhB,CAAA,EAAAc,EAAA,OAAAP,CAAA,IAAAD,CAAA,GAAAW,MAAA,CAAAC,cAAA,KAAAD,MAAA,CAAAE,wBAAA,CAAAnB,CAAA,EAAAc,EAAA,OAAAP,CAAA,CAAAK,GAAA,IAAAL,CAAA,CAAAM,GAAA,IAAAP,CAAA,CAAAE,CAAA,EAAAM,EAAA,EAAAP,CAAA,IAAAC,CAAA,CAAAM,EAAA,IAAAd,CAAA,CAAAc,EAAA,WAAAN,CAAA,KAAAR,CAAA,EAAAC,CAAA;AAAA,SAOhCmB,QAAQA,CAAA;EAAA,OAAAC,SAAA,CAAAC,KAAA,OAAAC,SAAA;AAAA;AAAA,SAAAF,UAAA;EAAAA,SAAA,OAAAG,kBAAA,CAAAd,OAAA,EAAvB,aAAwC;IACtC,IAAI;MAEF,OAAOX,OAAO,CAAC,4BAA4B,CAAC;IAC9C,CAAC,CAAC,OAAA0B,OAAA,EAAM;MACN,OAAO,IAAI;IACb;EACF,CAAC;EAAA,OAAAJ,SAAA,CAAAC,KAAA,OAAAC,SAAA;AAAA;AAAA,SAuBqBG,WAAWA,CAAAC,EAAA;EAAA,OAAAC,YAAA,CAAAN,KAAA,OAAAC,SAAA;AAAA;AAAA,SAAAK,aAAA;EAAAA,YAAA,OAAAJ,kBAAA,CAAAd,OAAA,EAA1B,WACLmB,GAAW,EAEM;IAAA,IADjBC,IAAiB,GAAAP,SAAA,CAAAQ,MAAA,QAAAR,SAAA,QAAAS,SAAA,GAAAT,SAAA,MAAG,CAAC,CAAC;IAEtB,IAAMU,IAAI,SAASb,QAAQ,CAAC,CAAC;IAE7B,IAAI,CAACa,IAAI,EAAE;MACT,OAAOJ,GAAG;IACZ;IAEA,IAAAK,YAAA,GAMIJ,IAAI,CALNK,MAAM;MAANA,MAAM,GAAAD,YAAA,cAAG,GAAG,GAAAA,YAAA;MAAAE,YAAA,GAKVN,IAAI,CAJNO,MAAM;MAANA,MAAM,GAAAD,YAAA,cAAG,GAAG,GAAAA,YAAA;MAAAE,eAAA,GAIVR,IAAI,CAHNS,SAAS;MAATA,SAAS,GAAAD,eAAA,cAAG,IAAI,GAAAA,eAAA;MAAAE,aAAA,GAGdV,IAAI,CAFNW,OAAO;MAAPA,OAAO,GAAAD,aAAA,cAAG,CAAC,GAAAA,aAAA;MAAAE,YAAA,GAETZ,IAAI,CADNa,MAAM;MAANA,MAAM,GAAAD,YAAA,cAAG,KAAK,GAAAA,YAAA;IAGhB,IAAcE,CAAC,GAAKX,IAAI,CAAhBA,IAAI;IAGZ,IAAMY,IAAI,SAASD,CAAC,CAACE,IAAI,CAACC,OAAO,CAAClB,GAAG,CAAC;IACtC,IAAMmB,GAAG,GAAGJ,CAAC,CAACK,KAAK,CAACC,oBAAoB,CAACL,IAAI,CAAC;IAE9C,IAAI,CAACG,GAAG,EAAE;MACR,OAAOnB,GAAG;IACZ;IAEA,IAAMsB,CAAC,GAAGH,GAAG,CAACI,KAAK,CAAC,CAAC;IACrB,IAAMC,CAAC,GAAGL,GAAG,CAACM,MAAM,CAAC,CAAC;IAEtB,IAAMC,OAAO,GAAGX,CAAC,CAACY,OAAO,CAACC,WAAW,CAACN,CAAC,EAAEE,CAAC,CAAC;IAE3C,IAAI,CAACE,OAAO,EAAE;MACZ,OAAO1B,GAAG;IACZ;IAEA,IAAM6B,MAAM,GAAGH,OAAO,CAACI,SAAS,CAAC,CAAC;IAGlC,IAAMC,WAAW,GAAGhB,CAAC,CAACY,OAAO,CAACC,WAAW,CAACN,CAAC,EAAEE,CAAC,CAAC;IAE/C,IAAI,CAACO,WAAW,EAAE;MAChB,OAAO/B,GAAG;IACZ;IAEA,IAAMgC,UAAU,GAAGD,WAAW,CAACD,SAAS,CAAC,CAAC;IAC1C,IAAMG,SAAS,GAAGlB,CAAC,CAACmB,KAAK,CAAC,CAAC;IAC3BD,SAAS,CAACE,cAAc,CAACpB,CAAC,CAACqB,WAAW,CAACC,QAAQ,CAAC7B,MAAM,EAAEA,MAAM,EAAE,OAAO,CAAC,CAAC;IACzEwB,UAAU,CAACM,SAAS,CAACnB,GAAG,EAAE,CAAC,EAAE,CAAC,EAAEc,SAAS,CAAC;IAC1C,IAAMM,OAAO,GAAGR,WAAW,CAACS,iBAAiB,CAAC,CAAC;IAI/C,IAAMC,IAAI,GAAG;AACf;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,GAAG;IAED,IAAMC,MAAM,GAAG3B,CAAC,CAAC4B,aAAa,CAACC,IAAI,CAACH,IAAI,CAAC;IAEzC,IAAI,CAACC,MAAM,EAAE;MACX,OAAO1C,GAAG;IACZ;IAGA,IAAM6C,MAAM,GAAGH,MAAM,CAACI,UAAU,CAE9B;MAAExC,MAAM,EAANA,MAAM;MAAEI,SAAS,EAATA;IAAU,CAAC,EAErB,CACES,GAAG,CAAC4B,iBAAiB,CAAC,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC,EAC7BR,OAAO,CAACQ,iBAAiB,CAAC,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC,CAErC,CAAC;IAED,IAAMC,CAAC,GAAGjC,CAAC,CAACmB,KAAK,CAAC,CAAC;IACnBc,CAAC,CAACC,SAAS,CAACJ,MAAM,CAAC;IACnBhB,MAAM,CAACqB,QAAQ,CAACnC,CAAC,CAACoC,QAAQ,CAAC,CAAC,EAAE,CAAC,EAAE7B,CAAC,EAAEE,CAAC,CAAC,EAAEwB,CAAC,CAAC;IAG1C,IAAMI,IAAI,GAAG1B,OAAO,CAACc,iBAAiB,CAAC,CAAC;IACxC,IAAMa,MAAM,GACVvC,MAAM,KAAK,KAAK,GACZsC,IAAI,CAACE,cAAc,CAAC,CAAC,GACrBF,IAAI,CAACE,cAAc,CAACvC,CAAC,CAACwC,WAAW,CAACC,IAAI,EAAEC,IAAI,CAACC,KAAK,CAAC9C,OAAO,GAAG,GAAG,CAAC,CAAC;IAExE,IAAM+C,OAAO,GAAG,GAAG3F,UAAU,CAAC4F,cAAc,OAAOC,IAAI,CAACC,GAAG,CAAC,CAAC,IAAIhD,MAAM,EAAE;IACzE,MAAM9C,UAAU,CAAC+F,kBAAkB,CAACJ,OAAO,EAAEN,MAAM,EAAE;MACnDW,QAAQ,EAAEhG,UAAU,CAACiG,YAAY,CAACC;IACpC,CAAC,CAAC;IAEF,OAAOP,OAAO;EAChB,CAAC;EAAA,OAAA5D,YAAA,CAAAN,KAAA,OAAAC,SAAA;AAAA","ignoreList":[]}