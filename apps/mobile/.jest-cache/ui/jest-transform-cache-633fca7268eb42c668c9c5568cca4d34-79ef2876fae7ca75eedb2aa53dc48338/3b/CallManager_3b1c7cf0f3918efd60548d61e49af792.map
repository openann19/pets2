{"version":3,"names":["_react","_interopRequireWildcard","require","_core","_reactNative","_useSocket","_ActiveCallScreen","_interopRequireDefault","_IncomingCallScreen","_WebRTCService","_jsxRuntime","e","t","WeakMap","r","n","__esModule","o","i","f","__proto__","default","has","get","set","_t","hasOwnProperty","call","Object","defineProperty","getOwnPropertyDescriptor","CallManager","_ref","children","_useState","useState","WebRTCService","getCallState","_useState2","_slicedToArray2","callState","setCallState","_useState3","_useState4","showIncomingCall","setShowIncomingCall","_useState5","_useState6","showActiveCall","setShowActiveCall","socket","useSocket","useEffect","initialize","handleCallStateChange","newState","isActive","isIncoming","isConnected","handleCallError","error","Alert","alert","text","logger","on","handleAppStateChange","nextAppState","info","appStateSubscription","AppState","addEventListener","off","remove","handleAnswerCall","_ref2","_asyncToGenerator2","success","answerCall","apply","arguments","handleRejectCall","rejectCall","handleEndCall","style","onPress","endCall","handleToggleMute","toggleMute","handleToggleVideo","toggleVideo","handleSwitchCamera","switchCamera","handleToggleSpeaker","toggleSpeaker","jsxs","Fragment","jsx","Modal","visible","animationType","presentationStyle","onRequestClose","callData","onAnswer","onReject","onEndCall","onToggleMute","onToggleVideo","onSwitchCamera","onToggleSpeaker","useCallManager","exports","startCall","_ref3","matchId","callType","_x","_x2","isCallActive"],"sources":["CallManager.tsx"],"sourcesContent":["import React, { useState, useEffect } from \"react\";\nimport { logger } from \"@pawfectmatch/core\";\nimport type { AppStateStatus } from \"react-native\";\nimport { Modal, Alert, AppState } from \"react-native\";\n\nimport { useSocket } from \"../../hooks/useSocket\";\nimport ActiveCallScreen from \"../../screens/calling/ActiveCallScreen\";\nimport IncomingCallScreen from \"../../screens/calling/IncomingCallScreen\";\nimport type { CallState } from \"../../services/WebRTCService\";\nimport WebRTCService from \"../../services/WebRTCService\";\nimport type { CallData } from \"../../services/WebRTCService\";\n\ninterface CallManagerProps {\n  children: React.ReactNode;\n}\n\nexport default function CallManager({ children }: CallManagerProps) {\n  const [callState, setCallState] = useState<CallState>(\n    WebRTCService.getCallState(),\n  );\n  const [showIncomingCall, setShowIncomingCall] = useState(false);\n  const [showActiveCall, setShowActiveCall] = useState(false);\n  const socket = useSocket();\n\n  useEffect(() => {\n    // Initialize WebRTC service with socket\n    if (socket) {\n      WebRTCService.initialize(socket);\n    }\n\n    // Listen for call state changes\n    const handleCallStateChange = (newState: CallState) => {\n      setCallState(newState);\n\n      if (newState.isActive && newState.isIncoming && !newState.isConnected) {\n        // Show incoming call screen\n        setShowIncomingCall(true);\n        setShowActiveCall(false);\n      } else if (newState.isActive && !newState.isIncoming) {\n        // Show active call screen\n        setShowIncomingCall(false);\n        setShowActiveCall(true);\n      } else if (!newState.isActive) {\n        // Hide all call screens\n        setShowIncomingCall(false);\n        setShowActiveCall(false);\n      }\n    };\n\n    const handleCallError = (error: unknown) => {\n      Alert.alert(\n        \"Call Error\",\n        \"There was an issue with the call. Please try again.\",\n        [{ text: \"OK\" }],\n      );\n      logger.error(\"Call error:\", { error });\n    };\n\n    // Add event listeners\n    WebRTCService.on(\"callStateChanged\", handleCallStateChange);\n    WebRTCService.on(\"callError\", handleCallError);\n\n    // Handle app state changes (for background/foreground)\n    const handleAppStateChange = (nextAppState: AppStateStatus) => {\n      if (nextAppState === \"background\" && callState.isActive) {\n        // Handle call in background - could implement picture-in-picture\n        logger.info(\"Call moved to background\");\n      } else if (nextAppState === \"active\" && callState.isActive) {\n        // Call returned to foreground\n        logger.info(\"Call returned to foreground\");\n      }\n    };\n\n    const appStateSubscription = AppState.addEventListener(\n      \"change\",\n      handleAppStateChange,\n    );\n\n    return () => {\n      WebRTCService.off(\"callStateChanged\", handleCallStateChange);\n      WebRTCService.off(\"callError\", handleCallError);\n      appStateSubscription?.remove();\n    };\n  }, [socket]);\n\n  // Call action handlers\n  const handleAnswerCall = async () => {\n    try {\n      const success = await WebRTCService.answerCall();\n      if (success) {\n        setShowIncomingCall(false);\n        setShowActiveCall(true);\n      }\n    } catch (error) {\n      Alert.alert(\"Error\", \"Failed to answer call\");\n    }\n  };\n\n  const handleRejectCall = () => {\n    WebRTCService.rejectCall();\n    setShowIncomingCall(false);\n  };\n\n  const handleEndCall = () => {\n    Alert.alert(\"End Call\", \"Are you sure you want to end this call?\", [\n      { text: \"Cancel\", style: \"cancel\" },\n      {\n        text: \"End Call\",\n        style: \"destructive\",\n        onPress: () => {\n          WebRTCService.endCall();\n          setShowActiveCall(false);\n        },\n      },\n    ]);\n  };\n\n  const handleToggleMute = () => {\n    WebRTCService.toggleMute();\n  };\n\n  const handleToggleVideo = () => {\n    WebRTCService.toggleVideo();\n  };\n\n  const handleSwitchCamera = () => {\n    WebRTCService.switchCamera();\n  };\n\n  const handleToggleSpeaker = () => {\n    WebRTCService.toggleSpeaker();\n  };\n\n  return (\n    <>\n      {children}\n\n      {/* Incoming Call Modal */}\n      <Modal\n        visible={showIncomingCall}\n        animationType=\"slide\"\n        presentationStyle=\"fullScreen\"\n        onRequestClose={handleRejectCall}\n      >\n        {callState.callData && (\n          <IncomingCallScreen\n            callData={callState.callData}\n            onAnswer={handleAnswerCall}\n            onReject={handleRejectCall}\n          />\n        )}\n      </Modal>\n\n      {/* Active Call Modal */}\n      <Modal\n        visible={showActiveCall}\n        animationType=\"slide\"\n        presentationStyle=\"fullScreen\"\n        onRequestClose={handleEndCall}\n      >\n        <ActiveCallScreen\n          callState={callState}\n          onEndCall={handleEndCall}\n          onToggleMute={handleToggleMute}\n          onToggleVideo={handleToggleVideo}\n          onSwitchCamera={handleSwitchCamera}\n          onToggleSpeaker={handleToggleSpeaker}\n        />\n      </Modal>\n    </>\n  );\n}\n\n// Export hook for easy access to call functionality\nexport const useCallManager = () => {\n  const startCall = async (matchId: string, callType: \"voice\" | \"video\") => {\n    try {\n      const success = await WebRTCService.startCall(matchId, callType);\n      if (!success) {\n        Alert.alert(\n          \"Error\",\n          \"Failed to start call. Please check your permissions and try again.\",\n        );\n      }\n      return success;\n    } catch (error) {\n      Alert.alert(\"Error\", \"Failed to start call\");\n      return false;\n    }\n  };\n\n  const endCall = () => {\n    WebRTCService.endCall();\n  };\n\n  const isCallActive = () => {\n    return WebRTCService.isCallActive();\n  };\n\n  const getCallState = () => {\n    return WebRTCService.getCallState();\n  };\n\n  return {\n    startCall,\n    endCall,\n    isCallActive,\n    getCallState,\n  };\n};\n"],"mappings":"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","ignoreList":[]}