id: chat-reactions-attachments
owner: api
severity: high  
area: mobile+contracts
context: |
  Basic text chat exists but lacks modern engagement features.
  Users expect reactions (üëç‚ù§Ô∏èüòÇ), photo/video attachments, and voice messages.
  Current limitation reduces user engagement and retention.
  Competitive apps all have these features as standard.

acceptance:
  - Long-press message shows reaction picker with common emoji
  - Attachment button opens media picker (camera, gallery, files)
  - Voice message recording with waveform visualization
  - All media types properly preview in chat bubble  
  - Reactions display with count and user indicators
  - E2E test covers all interaction flows

states:
  - idle: normal chat state
  - selecting-reaction: reaction picker visible
  - selecting-attachment: media picker open
  - recording-voice: voice recording in progress
  - uploading-media: attachment upload progress
  - sending-message: message with media being sent
  - error: upload failed or unsupported media type

telemetry:
  - event: CHAT_REACTION_ADDED
    props: [emoji, message_id, match_id]
  - event: CHAT_ATTACHMENT_SENT
    props: [media_type, file_size_kb, match_id]
  - event: CHAT_VOICE_SENT
    props: [duration_seconds, match_id]
  - event: CHAT_MEDIA_UPLOAD_FAILED
    props: [media_type, error_code, file_size_kb]

contracts:
  reactions:
    request:
      messageId: string
      emoji: string       # unicode emoji
      action: 'add' | 'remove'
    response:
      success: boolean
      reactions: Array<{emoji: string, count: number, userReacted: boolean}>

  attachments:
    request:
      matchId: string
      mediaType: 'image' | 'video' | 'voice' | 'file'
      file: Blob | FormData
      duration?: number   # for voice messages
    response:
      success: boolean
      messageId: string
      mediaUrl: string
      thumbnailUrl?: string

  errors:
    - 400: { code: 'UNSUPPORTED_MEDIA', message: 'File type not supported' }
    - 413: { code: 'FILE_TOO_LARGE', message: 'File exceeds 10MB limit' }
    - 422: { code: 'INVALID_EMOJI', message: 'Emoji not in allowed set' }

assets:
  simulations:
    - simulations/fixtures/chat/reaction-success.json
    - simulations/fixtures/chat/attachment-upload.json
    - simulations/fixtures/chat/voice-message.json
  tests:
    - apps/mobile/src/components/__tests__/ChatBubble.reactions.test.tsx
    - apps/mobile/src/components/__tests__/AttachmentPicker.test.tsx  
    - apps/mobile/src/components/__tests__/VoiceRecorder.test.tsx
    - e2e/chat-reactions-attachments.e2e.ts

ui_components:
  - ReactionPicker: emoji grid with common reactions
  - AttachmentPicker: camera/gallery/files bottom sheet
  - VoiceRecorder: waveform + duration display
  - MediaBubble: image/video with loading states
  - VoiceBubble: waveform + play button + duration

media_constraints:
  images: 
    - formats: [jpg, png, webp]
    - max_size: 10MB
    - max_dimensions: 2048x2048
  videos:
    - formats: [mp4, mov]
    - max_size: 50MB  
    - max_duration: 60s
  voice:
    - format: m4a/aac
    - max_size: 10MB
    - max_duration: 120s

accessibility:
  - Reaction picker: voice over labels for each emoji
  - Voice messages: "Play voice message, duration X seconds"
  - Images: alt text extraction or user-provided description
  - Recording: haptic feedback + voice over progress

performance:
  - Image compression before upload
  - Progressive JPEG for faster loading
  - Voice message streaming playback
  - Lazy loading for media in chat history

status: open
priority: P1
created: 2024-01-15T10:30:00Z
assignee: api-contract-agent
labels: [chat, media, mobile, backend, ux]